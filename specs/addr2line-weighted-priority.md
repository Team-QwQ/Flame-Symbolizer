# 权重优先符号化启发式规格

## 背景与问题
- 火焰图的决策价值主要集中在高权重（计数大）的调用栈；在大输入下全量解析会放大耗时。
- 需要在不破坏输出格式的前提下，优先解析最有价值的调用栈，并允许用户按需扩大覆盖面。

## 目标
- 默认启用“权重优先”模式：只解析前 10% 权重最高的调用栈行，其余行保持原样地址输出。
- 提供参数可调节解析覆盖度（例如提高至 30%、100%，或关闭权重优先）。
- 保持最终输出的行序与输入一致，保证可与现有流水线、火焰图工具兼容。

## 非目标
- 不在本规格中实现并行化、分布式或 JSON 输出。
- 不修改 maps 解析、符号目录匹配与 addr2line 调用语义（继承主规格）。
- 不追求精确的“总权重覆盖率”优化，只做基于行权重的启发式。

## 术语与权重定义
- “权重”指 stackcollapse 行末的计数字段（整型，必需可解析）；无法解析的行视为权重 0。
- “Top X%”指按权重降序排列的行，取行数上限为 `ceil(total_lines * X/100)`；若权重相同导致边界不确定，则包含达到上限所需的行并保持稳定排序（先出现者先入选）。

## 功能需求
1. **模式与默认值**
   - 新增可选参数（示例）：`--weight-top-percent <int>`（0-100），默认值 10；值为 100 等同于关闭权重优先（全量解析）。
   - 可选开关 `--weight-mode {weighted,all}`，默认 `weighted`；当为 `all` 时忽略 `--weight-top-percent`，全量解析。
   - 若两者冲突，以 `--weight-mode` 优先级更高（`all` 覆盖掉百分比限制）。

2. **输入与流式约束**
   - 需要可重读/可 seek 的输入（文件路径或可回放的缓冲）。若输入为管道/STDIN 且不可重复读取，应自动降级为全量解析并输出告警（带 `[WARN]` 前缀），保证结果完整性。
   - 对于可重读文件，允许两阶段：第一阶段扫描权重确定阈值，第二阶段按原序处理并仅对入选行做符号化。

3. **处理流程**
   - 预扫描阶段：读取全量行，计算权重并记录原始行序号；确定 Top 百分比的行集合，不做符号化。
   - 符号化阶段：按原行序遍历；若行在 Top 集合内则走正常符号化流程（含缓存、批处理等既有优化）；否则直接透传原行文本。
   - 输出顺序必须与输入一致；不可因权重排序打乱输出。

4. **与既有优化的协同**
   - 保持地址级批处理、缓存与模块查找逻辑不变；Top 集合内的行仍可以共享已有缓存收益。
   - 重跑时，提升 `--weight-top-percent` 应继续复用缓存（如果实现层面有缓存落地或进程内缓存仍在）。

5. **可观察性与告警**
   - 默认模式下，在 stderr（或 debug）输出一次概要：行数、Top 百分比、被解析行数与被跳过行数。
   - 当输入不可重读而降级为全量解析时，应输出单次告警，说明权重优先未生效。

## 兼容性
- 不改变现有 CLI 选项的默认含义；新增参数保持向后兼容。
- 输出格式、符号化规则、告警格式（`[WARN]` 前缀）与主规格一致。

## 验收标准
- 给定示例输入（可重读文件）且默认配置，只有 Top 10% 行被符号化，其余行原样透传；输出行序与输入一致。
- 将 `--weight-top-percent` 设为 100 或 `--weight-mode all` 时，全量行均被符号化，行为与未开启权重优先时一致。
- 当输入来自管道且不可重复读取时，脚本输出单次告警并执行全量符号化，结果与基线全量模式一致。
- 现有夹具与性能测试均应保持通过；新增的权重优先默认不应破坏任何已有验收标准（与主规格、性能规约兼容）。

## 风险与未决问题
- 双遍读取需要额外 I/O 开销；在极大文件上可能抵消收益，需要后续性能评估。
- 权重分布若均匀（无明显长尾），Top 10% 可能覆盖价值有限；默认策略的收益需在真实数据上验证。
- STDIN/管道场景下默认降级全量，可能与用户预期不符；需要在文档中明确。

## 关联文档
- 主规格：[specs/addr2line-symbolizer.md](addr2line-symbolizer.md)
- 性能规约：[specs/addr2line-performance.md](addr2line-performance.md)
