# find_map_segment 二分查找优化计划

## 范围与规格
- 范围：优化 `find_map_segment` 的段查找为二分查找，降低 `first_pass_collect` CPU 开销。
- 规格来源：参见 [specs/2025-12-19-find-map-bsearch-spec.md](../specs/2025-12-19-find-map-bsearch-spec.md)。

## 假设与不在范围
- 假设 /proc/<pid>/maps 按起始地址升序（内核保证）。
- 不修改 CLI、输入输出格式、去重策略、addr2line 调用、日志语义。
- 不合并或重写 maps 段；保持每段独立偏移/权限。

## 分阶段步骤（可验证）
1) 实现：将 `find_map_segment` 改为二分查找，保证返回索引行为与线扫一致（含边界/重叠防御）。
2) 回归：运行 `tests/run-fixture.sh` 确认输出一致。
3) 对比（可选）：在大 maps/大唯一地址合成输入上对比前后运行时间，记录一次性性能对比结果。

## 验证策略
- 必跑：`tests/run-fixture.sh`。
- 若资源允许：合成 ≥500 段、≥50k 唯一地址输入，对比优化前后总耗时并记录。

## 风险与缓解
- 风险：二分实现偏差导致选错段或漏段。
  - 缓解：对边界/未覆盖/重复 start 的输入在本地比对线扫与二分结果；必要时命中后向左探查相同 start 以匹配旧行为。
- 风险：性能测试噪声。
  - 缓解：多次运行取中位数，或只在可控环境记录相对变化。

## 审批与下一步
- 状态：待批准计划。
- 批准后进入 `/do`，按步骤实施与验证。
